schema: draft-07
name: aws-eks-cluster
description: An open source container orchestration platform that automates many of the manual processes involved in deploying, managing, and scaling containerized applications.
ref: github.com/massdriver-cloud/aws-eks-cluster
access: public
type: bundle

steps:
  - path: src
    provisioner: terraform
  - path: core-services
    provisioner: terraform
  - path: custom-resources
    provisioner: terraform

params:
  examples:
    - __name: Development
      k8s_version: "1.21"
      node_groups:
        - name_suffix: shared
          instance_type: t3.medium
          min_size: 1
          max_size: 10
    - __name: Production
      k8s_version: "1.21"
      node_groups:
        - name_suffix: shared
          instance_type: c5.2xlarge
          min_size: 1
          max_size: 10
  required:
    - k8s_version
    - node_groups
    - core_services
  properties:
    k8s_version:
      type: string
      title: Kubernetes Version
      description: The version of Kubernetes to run
      enum:
        - "1.19"
        - "1.20"
        - "1.21"
        - "1.22"
    node_groups:
      type: array
      title: Node Groups
      descrition: Node groups to provision
      minItems: 1
      items:
        type: object
        title: Node Group
        description: Definition of a node group
        required:
          - name_suffix
          - instance_type
          - min_size
          - max_size
        properties:
          name_suffix:
            type: string
            title: Name
            description: The name of the node group
            pattern: "[a-z]{1,}[a-z0-9]{0,19}"
            message:
              pattern: Name must be between 1 and 20 lowercase letters or numbers, and must start with a letter.
            default: ""
          min_size:
            type: integer
            title: Minimum Size
            description: Minimum number of instances in the node group
            default: 1
            minimum: 0
          max_size:
            type: integer
            title: Maximum Size
            description: Maximum number of instances in the node group
            default: 10
            minimum: 0
          instance_type:
            title: Instance type
            description: Instance type to use in the node group
            type: string
            oneOf:
              - title: C5 High-CPU Large (2 vCPUs, 4.0 GiB)
                const: c5.large
              - title: C5 High-CPU Extra Large (4 vCPUs, 8.0 GiB)
                const: c5.xlarge
              - title: C5 High-CPU Double Extra Large (8 vCPUs, 16.0 GiB)
                const: c5.2xlarge
              - title: C5 High-CPU Quadruple Extra Large (16 vCPUs, 32.0 GiB)
                const: c5.4xlarge
              - title: C5 High-CPU 9xlarge (36 vCPUs, 72.0 GiB)
                const: c5.9xlarge
              - title: C5 High-CPU 12xlarge (48 vCPUs, 96.0 GiB)
                const: c5.12xlarge
              - title: C5 High-CPU 18xlarge (72 vCPUs, 144.0 GiB)
                const: c5.18xlarge
              - title: C5 High-CPU 24xlarge (96 vCPUs, 192.0 GiB)
                const: c5.24xlarge
              - title: M5 General Purpose Large (2 vCPUs, 8.0 GiB)
                const: m5.large
              - title: M5 General Purpose Extra Large (4 vCPUs, 16.0 GiB)
                const: m5.xlarge
              - title: M5 General Purpose Double Extra Large (8 vCPUs, 32.0 GiB)
                const: m5.2xlarge
              - title: M5 General Purpose Quadruple Extra Large (16 vCPUs, 64.0 GiB)
                const: m5.4xlarge
              - title: M5 General Purpose Eight Extra Large (32 vCPUs, 128.0 GiB)
                const: m5.8xlarge
              - title: M5 General Purpose 12xlarge (48 vCPUs, 192.0 GiB)
                const: m5.12xlarge
              - title: M5 General Purpose 16xlarge (64 vCPUs, 256.0 GiB)
                const: m5.16xlarge
              - title: M5 General Purpose 24xlarge (96 vCPUs, 384.0 GiB)
                const: m5.24xlarge
              - title: T3 Small (2 vCPUs for a 4h 48m burst, 2.0 GiB)
                const: t3.small
              - title: T3 Medium (2 vCPUs for a 4h 48m burst, 4.0 GiB)
                const: t3.medium
              - title: T3 Large (2 vCPUs for a 7h 12m burst, 8.0 GiB)
                const: t3.large
              - title: T3 Extra Large (4 vCPUs for a 9h 36m burst, 16.0 GiB)
                const: t3.xlarge
              - title: T3 Double Extra Large (8 vCPUs for a 9h 36m burst, 32.0 GiB)
                const: t3.2xlarge
              - title: P2 General Purpose GPU Extra Large (4 vCPUs, 61.0 GiB)
                const: p2.xlarge
              - title: P2 General Purpose GPU Eight Extra Large (32 vCPUs, 488.0 GiB)
                const: p2.8xlarge
              - title: P2 General Purpose GPU 16xlarge (64 vCPUs, 732.0 GiB)
                const: p2.16xlarge
    core_services:
      type: object
      title: Core Services
      description: Configure core services in Kubernetes for Massdriver to manage
      required: []
      properties:
        enable_ingress:
          type: boolean
          title: Enable Ingress
          description: Enabling this will create an nginx ingress controller in the cluster, allowing internet traffic to flow into web accessible services within the cluster
          default: false
        route53_hosted_zones:
          type: array
          title: Route53 Hosted Zones
          description: Route53 Hosted Zones to associate with this cluster. Enables Kubernetes to automatically manage DNS records and SSL certificates. Hosted Zones can be configured at https://app.massdriver.cloud/dns-zones.
          default: []
          items:
            title: "Route53 Hosted Zone"
            description: ""
            # TODO: Require a HostedZone ARN: arn:aws:route53:::hostedzone/Z0267127WDKJABXSA830 which isnt _quite a standard ARN.
            $ref: https://raw.githubusercontent.com/massdriver-cloud/artifact-definitions/main/definitions/types/aws-arn.json

connections:
  required:
    - aws_authentication
    - vpc
  properties:
    aws_authentication:
      $ref: massdriver/aws-iam-role
    vpc:
      $ref: massdriver/aws-vpc

artifacts:
  required:
    - kubernetes_cluster
  properties:
    kubernetes_cluster:
      $ref: massdriver/kubernetes-cluster

ui:
  ui:order:
    - k8s_version
    - node_groups
    - core_services
    - "*"
  node_groups:
    items:
      ui:order:
        - name_suffix
        - instance_type
        - min_size
        - max_size
        - "*"
  core_services:
    ui:order:
      - enable_ingress
      - route53_hosted_zones
    route53_hosted_zones:
      items:
        ui:field: dnsZonesDropdown
        cloud: aws
